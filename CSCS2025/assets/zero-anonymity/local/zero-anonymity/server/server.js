const express = require('express');
const bodyParser = require('body-parser');
const snarkjs = require('snarkjs');
const path = require('path');
const fs = require('fs');

const web_path = path.join(__dirname, 'public');
const vkey_path = path.join(__dirname, 'verification_key.json')
const index_path = path.join(__dirname, '/views/index.ejs')
const results_path = path.join(__dirname, '/views/results.ejs')
const port = 9000;

const app = express();
app.use(bodyParser.json());
app.set('view engine', 'ejs');

// TODO: put this into MongoDB...
var users = [
    "79139473236799360219983169446687512273197369512319236848325149503676953274:9953177108241985573852593981348935076235021734165441624898032829590773104310",
    "20505282514967751285415557074372831621289361932737297220242415814295612558598:14902451265179849718849868064960492071191629148765893414969592220410835224937",
    "3771730623804983183598947582045554090301550476358669879805820837746198405991:138383122107223483477770071559921425945278445021222949381824542193173739610",
    "5509901169522069121985675738456993710369734468031368081936406796465258005288:1377343799488233288944754822645238010994240140951475316357964674458695608987",
    "3244542779256308509325893916226426251658788924393594150364519305149082283462:7218425897995848071771056660498418207050193828080067902979381262408362892532",
    "8063853439791768429620461602191580809892061175672924352091016523264671590395:18024670006734163239891107689632077306162166043882850075966757713012417788893",
    "21345409937536169481743484355037043063125674899394991834954429428497356924333:15346301608736975936950143914548290763116052958002114591354612438403312598613",
    "13202996080686429478943848234624741851635577688379950060140618690024139066719:3726544412907903680819462444419594507237317991958457090360663912894660855945",
    "16804566185157900930908362073398821898209218028312033634211843166489552309690:9353090764574626393566924131235567516232993602207641202070627212065018818664",
    "1302529054655129807040470426034627216508296205196313890966968258446119233496:16046014289716439388291023032732752992697010057676991955709693591746231869311",
    "20730958878927763348152102663350360560240459367092461256307855357077006076764:20378817324148159924934263220462104195485868008787975145449708634380197468111",
    "2771950788861740663099760527851153818721185495644498958125610730869393455242:8798229952801831223145351495306436522671898460831398456066694703763243311609",
    "13471263691230453186544988305125624096138361912694832931185950355282284406024:17648771716699340835399404740565680842350794962877756044618983332991043885142",
    "16618958719503153533219258793407630258915039832828084005998961796322600461238:20415067167093341062011385481665469384535276891925033328191534820357454327593",
    "7799771112731570671027441313870028613953055209464471010380585902880246605254:3396363798112546364887911575174496887330313975739987099924020219154144660095",
    "2847731662000552685060723245659070803756874072764539825288541478339321623958:17048218340398454053088425852103674252139312295191382768030444665462394511680",
    "15826556059763883705610699779064845947273194031635447685066340049364646732039:19675780261830111805295040681852948760046975600641634293068519199405163609303",
    "14385586853368690519545200511451331974280899396368579563221176412264873252133:10073434470689631468066669991708784032405761579739223547531151607133594402327",
    "966741150654921336082451236432279448109408616766401538695396429481817902975:4357654672762482076573688853506384109421603792330293905187505767402762625688",
    "71283276034662746874315541121256064514335930841142450760294994120754538840:898880487127687738026768518726037982207621949727216024784470344113676947139",
    "6631594111972331789084758103613379327777434432676321810877924220678534649119:14957723800454198326745737830489712141218526660236735192935309010119671170048",
    "289708776316250879086963873956836097023865673856816795876196896247669427916:8712313106516072362207720556236510854773083256585776760322264230513862399058",
    "19479658820717869083764118381897425402362345626532079660534279553133680721140:7647598440080762978266138294789149437121116126713662447423325229891321353032",
    "15384827259495570560659606150342301331999303996732472602045153051727541531598:8203568632896941926444474914094161991548125865048409008882438369918619475023",
    "5083516370488682126764916822571583445474627524928051166257534576178037401725:6247309786865947790923555026438757260582236377081325547876043277980663497330",
    "347915810918342548558486046390209121156896431303471765989748699651559889521:18829980315251859887645854393608392390903338805148459518853211769459955203004",
    "15362809609554117454749657236536298397756720182707612941998912328516662497919:4728806940799453350464340629093678195759565255431032755582301737295461133687",
    "14554648991379111068601669616616821088714583663625703024889435777550107156849:3129124361720258709527091027265277522019114619052943678066792050248031175139",
    "11486492381030443650202383461124066398456530759950413699981287989879896260966:15382159164154594702477339322693237668443259615270490226200762430668307035443",
    "2311322485856668907421099480275818738249095959778975646442808303838732979737:6117038602240708458902939039811104857522130124933148563583926075164554546313",
    "17445076579951373147260708153688610015570031172820801406900796597040742406873:4879321610617860978513382374908631671693447924962967690573866059285859086335",
    "21502884977331780449289191083626120379281774242199426569747835916156315865422:19327264910153354483908720375513149239315251376528364578941079108132057281652",
    "20334375081517891847694130001515084751913358519625229292100887611037363193738:4613732816222621742896487680416992219777957274973560989094343431483170461014",
    "7692827289810905872910518325628716857784087280892484307398612852597620972648:4097843753292963174235123242695112129511164881215390745559290600052776363587",
    "981688528557715322061872735258367240646723650132721678889365337981360276132:18500608263267234277737537068304598640091444877496631559545049452782245080268",
    "4899761937551978754327685843777955575125492491007183868920185053496568054767:8216341305089304736298720755932383552063917746221682727575735149599019955165",
    "20006346831952969323834210400795131884262926946834762805349422242467640867892:15015435273910924835145818884075289187711352098774358799196934139752546476043",
    "15248614533178840742227714271059652447668262536825257747864941320738906612175:5607829128281152363652202887696524299441234656746414700298474345633324695500",
    "445215891719779534006459530229892180236916818665203472747505883200935926039:6155523213928064899969670895824215048558969564875717110902104140160476540514",
    "7067299189721087605048311458357800376057695962308857642119274102086469454310:19174899997517045497506568594555221566023553515057491399010016317189790996235",
    "1896403152978159131533362977350493718616199645898105323482454660452703266904:16143771899881225224286330217489267753938234373521763936613859696444733847308",
    "21014071604627254373057127743192727967068455305038856334164213690515778547699:8997457165670925247497233983441518834446339172965359862767406753137743834457",
    "15988553217022050433507249292504931852572406191457735683726649062428427040364:15989896845515775708190527149040575536984727601402511078071271899650759122622",
    "16016815774265309509802166319419297901126989423239410596841156972618401385583:8553714643790123021417551880684814469730374662613240838455611246935437689719",
    "2524370979291254206490616786451372011750419220408598682725786495956933471802:6396167454206030757416849334551327485395808535224683732250182037114290949140",
    "8210973451330790368632969897958125898821552699872655847118133815314751363928:10281261124383557431817380735577313955025222295420719308936281312281730698953",
    "11746713479045774677175830830475485166569758143434183861059833636433269211666:13836921918060124335951188233357921370554629728587928913628985917776190922824",
    "11106698757810994201053329951146302474850765356974894998465491233553565219758:13867571502656645772019840507894012968047993146064059959164915310595628541272",
    "12580355213261736665254184786716493218439446840998607704717610691460591407913:3803278663632021659179210284173146864491054230428370861186867741222070937308",
    "12252739477229487032983936706508129654349238349519723975058389181765857878220:12064423780003120388433137709060934608335495887673246636471709852761070776490",
    "5258911341128430149407997903146493994669838126155813518938139613460362152817:17542979603758020961473522986172585254317807550341664736049596999257519129093",
    "7474387584091396053783560008005646995237899172550277530067306793704765767369:18733298889990260421239715862713153418323041666010139512389419440961865115100",
    "14757182602459905966902749368947804537694092711955659503669007507033784535391:20196182621580838833973104765850378638732028239747023109304223675038334628942",
    "8080934186056705059047305853784741862511486544476795443080510876894710830567:19386170888003269611489730050731950727565821599363398092475370605535098886604",
    "14378197966727347660617309467885808710507524059232349750935524167833928704508:15431635295422989666934206154628107660434664590071087607382410424103538180137",
    "5210333729625165388998035080562517202860064364313920795020255211838294083581:16570303959044922827117225623673312628708156834984866867886077666391046742415",
    "21037734865331289225323228147845875981387955896934401792303309477203958266642:5871231479272513567456858282675439221733618776975645683611330539329317112876",
    "11897756442717343592231371741687865647793123307880992666129581838880451255945:10101632401377474972128433218111664652578609338678948055138698397344932878864",
    "15135754822072617944485841066259066873875448837156733791544886143171966503911:18667084420654742979293743946514234984592941403828604595458691576606602231980",
    "14500649962846554856980867636441619701454975398446362969594031193433660548347:12778284572959934344995380429713358827714113911571542946398022880079872954369",
    "11419157255994761649813663062193050112714911974306161248905777936512271567729:18179295380747494566964876939805530814912218183143629818433607569378653649476",
    "2423613530692782579552991579680376234608029828619937594319292773650832997557:19723149787118751674280160237622442191490286592117231766766005033412840799331",
    "2978630172147020198141348485640908669635670105328723951631050479546789305118:292653476205700355385282584897277179287887522321186726644095551605270844167",
    "21270113656883809656611996481383342777172446118307818772873632826273683831387:5151262524798583869761964402833856194493536265335267623176920393147068640719",
    "5898041100254869990621221411976915647619620196024434598010891501718175410057:18838711080487827288284547938020925474299488364967369784346004346801492629813",
    "6848424655130285955829594008330932606638841393638693810485202732486190521966:8161506130631333226050304045972995180595145220855617171529737169311454970113",
    "20362016873652587683497995480305472906801440066968683094739178597435191886888:4734440315702190383481611903799943741444939023189152645374686488427000942818",
    "4220460293050281432203026888015812631404453307128948531733503896107943591564:13861434806932661537320010161907734949435424748644794958192157713917464829335",
    "16096551421316198057002992427407667043232788682247003276792588599275798643214:12373393823451534107923263300895641399496888014222886039472151940011546176415",
    "6692950494557853215176704050162671786860251020269763828480435198474986901920:11255531092192056869263180417186423256577087448066508486100086772467827778718",
    "16336342492352583361697971995401146846831332178634288747695299111702973941865:18654732450640323674545707322949013716525646400741292748720316739000038941773",
    "15115383518594376132302039660982752464337884678104171233356548614188776413021:18935133351281621015447490663911663867918774050725347178263755900553677205938",
    "15668306383484286873061479012709626129234673153434467664267576856701793891403:21542450039470850738602721543322514015660093503746523563496602009543548991005",
    "13076973658609754539353962000404705452754333879003312610373534022825262851413:20086821105490776239431306640418641872508413863975520321587580527555157848966",
    "167500172311073220048961289894611576374618974299752370149802627669059610093:8922536766346575588767620140589195227661428527909105100262218458493009405112",
    "4136843536603568873871081457811201498559231797035592953774327996392941398159:4925981523698015626084941957766508948641006258989253123378327079445728467795",
    "6140147382327886927914309374863199847995626593969792599526693603894429607639:19738195419551454987679214958495430530973585456560511432181959887283596848440",
    "12060949754334008969310709418448205490692413432771221512475908290333062658293:16700372044114064614529530599347099538329196388675219254308128999091240301413",
    "14113657163673761928260201243923697843112475866332893751907191415324750681396:2822265193547170356854165455112081224724574023214524480717754945442777898859",
    "4307950333372106136833948519542161572454628794901093073234342835582725216576:20599722276742071946286995909962897351437552179754431165780727807474330723298",
    "6884644187355288485592357957971242778080164353468714625440123890391424254095:16108241903860544017398588695310918072052637575513669627006979458609355808894",
    "21346996792887274000318386667928685578906922933425298136204979750688167507143:18312658867184749952860482754584618902460462593866230956302263435413809152588",
    "8809598533826167576175008139603225817779439058467481922348208562238947443395:10532360382312017274056797068786336784002479390237620786294591131179425555510",
    "10850983985290730712789397627026911216385421397088669627933501607503136580434:13376933624132432828166893118181409960904143176136335372960917826127045669436",
    "13164184403537672668882667641846757309818632747716523475521813998014714977783:4050900198019691732698250904540209794564761383765583528733001068502356758170",
    "21119627177128647932597637036328985767553334710781348750749178263177830558305:19736701851288817314392254387632425301927130626001740755207119460066513457751",
    "19536518134202358878322248559119544236179844485543890105803588917102131521171:3353206461271941591724510673570067207432629675718699009995268761502813006647",
    "2605534870315015318093029630284254151585986191788504367317175034698772108420:7986325020651299095182470386333907362638032065442958857332704677652859484502",
    "18955048632003383861968402282099901885540347112782814776337483366799229793730:21098321394659102461233281663062020137939414142207789049106274978397083141697",
    "8575876876620817968899945678544878378129304288364184034453760430911356649977:16360317088219618790382118913178511148162377137525688356291393452058085835401",
    "4180802586084909333176984789288647594294266959383670164795763822614314513078:15112786873497813292888742352007559104715941310233014428819210055277789304907",
    "20503487532058040431708452202242187646257181306469288715187190627644698874106:9346239864542855594347693345208067141172375603475047519055019376791584661369",
    "2171197170869713848209495014925638786428120186487644711616435676344867769817:17695105668894085569979950325038491262140102788402661096089143977755410866320",
    "4706409998350243258296298720983555074959827321426607171725697333147509067756:8657801028302301234995779549284680557409874345692596508445365302333553725092",
    "2727934137548055381865637843460026911389694323144854006926310846273858416511:5628344805353684538243008112253974035779264205612785339155292968601963018406",
    "16644672331977379141333154163547916509995749125959918848103051216091661692404:16822184513237123516893295281658522200265122096666745472807322573043045662127",
    "563552988550134369663131879800877563844516900861953446563560016190603577237:13086884655141921637467192642660771395947888691837577260597077068137871810351",
    "3295914747841125229883473820457939258968215604179235250411773842205789024686:15535110865927592899800001660461848652638146295797770894493478563944324113723",
    "11173408024986377524958366412590253204376083245749592692979147786086718628135:5608834653077891510733653407453241250413933334619426709854486747456901397385",
    "16176181833084171533456783911188159413319562355074564573802795521862779238138:21579455931004066896403685660297726500604707243438768739327369147292281350174",
    "6024202547489619798423581398206165442683271629451165843016777716359534219130:6824088646376133434895669301349426789346255884155848420293829541731799831863",
    "7447804688279652606724807309009278478580140717487643635009801593468639489720:21670114209593457268370772895609938679861289533219349719700685341413259313266",
    "2634221956437167634250518892948270748536208272155380537812976655180702527528:7302661509337645052496741383996883341858248773809405219601698841101232610183"
];

const i2s = (i) => {
    var a = "";
    var h = BigInt(i).toString(16);
    for (var c = h.length; c > 0; c -= 2) {
        var ii = parseInt(h.substring(Math.max(0, c-2), c), 16);
        if(!(ii >> 4)) {
            return a;
        }
        a = String.fromCharCode(ii) + a;
    }
    return a;
}

app.use(express.static(path.join(__dirname, 'public')));

app.get('/', (req, res) => {
    res.render(index_path);
});

app.post('/search', async function(req, res){
    var pubid = req.body['pubid'];
    var proof = req.body['proof'];
    var query = req.body['query'];
    var user_hash = pubid[0] + ":" + pubid[1];

    if(!users.includes(user_hash)) {
        res.status(401);
        res.render(index_path, {error: "This user doesn't exist, what are you doing?"});
    }
    else {
        var proof_outcome = false;
        try {
            const vkey = JSON.parse(fs.readFileSync(vkey_path));
            proof_outcome = await snarkjs.groth16.verify(vkey, pubid, proof);
        }
        catch (error) {
            proof_outcome = false;
        }
        finally {
            if(proof_outcome) {
                var flag = undefined;
                if(i2s(pubid[2]) == "Thomas" && i2s(pubid[3]) == "Anderson" && i2s(pubid[4]) == "b4ckd0r") {
                    flag = process.env.FLAG;
                }
                res.render(results_path, {search: query, flag: flag});
            }
            else {
                res.status(401);
                res.render(index_path, {error: "Your authentication failed."});
            }
        }
    }
});

app.listen(port, function () {
    console.log('zero-authentication server listening on port ' + port);
})